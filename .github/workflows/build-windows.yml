name: Build Windows Executable

# NOTE: The code/main.py includes _MEIPASS-aware path resolution
# to handle asset loading in packaged executables.
# Without this, bundled asset folders will not load correctly.

on:
  push:
    branches: [ master, production ]
  pull_request:
    branches: [ master, production ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller code/main.py --onedir --noconfirm --clean `
        --collect-submodules code `
        --collect-all pygame `
        --collect-all pytmx `
        --add-data "audio;audio" `
        --add-data "graphics;graphics" `
        --add-data "data;data"
    
    - name: List build output
      run: |
        dir dist\
        Get-ChildItem -Recurse dist\ | Select-Object -First 50
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: PokemonRPG-Windows
        path: dist/main/
        if-no-files-found: error
    
    - name: Delete Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/github-script@v6
      with:
        script: |
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          const release = releases.data.find(r => r.tag_name === '${{ github.ref_name }}');
          if (release) {
            for (const asset of release.assets) {
              if (asset.name === 'PokemonRPG-Windows.zip') {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
              }
            }
          }
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: Pokemon RPG - Windows Build
        draft: false
        prerelease: false
        artifacts: dist/main/**/*
        artifactContentType: application/octet-stream
